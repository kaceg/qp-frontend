<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <title>Google Maps | Q-Park POC</title>

    <link rel="stylesheet" href="/static/css/publicwebsite.css">

    <script src="/static/js/jquery.2.2.4.min.js"></script>
    <script src="/static/js/jquery-ui.min.js"></script>
    <script src="/static/js/bootstrap.js"></script>
    <script src="/static/js/moment.js"></script>
    <script src="/static/js/jquery.matchHeight-min.js"></script>
    <script src="/static/js/selectboxit.min.js"></script>
    <script src="/static/js/gmap/markerclusterer.js"></script>
    <script src="/static/js/custom.js"></script>
</head>

<body id="body">

    <div class="qcontentpane">

        <section class="google-maps-search myqp-new">
            <div class="img-bg bg-gradient" data-background-image="http://m.q-park.ie/DesktopModules/QPark.AdvancedPFL/image.aspx?PoiContentID=46&type=logo"></div>
            <input id="google-maps-url" type="hidden" value="https://maps.googleapis.com/maps/api/js?key=AIzaSyCo1sZST0VSef3MJISi7F2qlVReuvLyzhU&libraries=places"
            />

            <div class="google-maps-search-input form">
                <div class="container relative">
                    <div class="form-group row visible-xs">
                        <div class="col-xs-12">
                            <span class="strong text-uppercase primary-color no-margin">Quality in parking</span>
                            <h2 class="strong big-h1 no-margin">Waar wil je naartoe?</h2>
                        </div>
                    </div>
                    <div class="google-maps-search-input-control form-group row">
                        <div class="col-xs-12">
                            <input type="text" class="form-control google-autocomplete" placeholder="Where do you want to go?" value="Bonnefantenmuseum, Avenue Ceramique, Maastricht, Netherlands">
                            <div class="google-maps-search-buttons-wrapper">
                                <div class="google-maps-search-buttons">
                                    <a id="current-location" href="#" class="current-location svg-icon hidden-xs">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="-17919.422 -23306.422 28 28">
                                            <defs>
                                                <style>
                                                    .cls-1 {
                                                        fill: #d3d3d3;
                                                    }
                                                </style>
                                            </defs>
                                            <g id="location-marker" transform="translate(-17919.422 -23306.422)">
                                                <g id="Group_1287" data-name="Group 1287" transform="translate(0)">
                                                    <path id="Path_3941" data-name="Path 3941" class="cls-1" d="M294.551,292.325a2.223,2.223,0,1,0,2.223,2.223A2.225,2.225,0,0,0,294.551,292.325Zm0,3.334a1.111,1.111,0,1,1,1.111-1.111A1.113,1.113,0,0,1,294.551,295.659Z"
                                                        transform="translate(-280.551 -280.547)" />
                                                    <path id="Path_3942" data-name="Path 3942" class="cls-1" d="M27.444,13.444h-6.67a6.808,6.808,0,0,0-6.218-6.218V.556a.556.556,0,0,0-1.112,0v6.67a6.808,6.808,0,0,0-6.219,6.218H.556a.556.556,0,1,0,0,1.112h6.67a6.808,6.808,0,0,0,6.219,6.218v6.67a.556.556,0,0,0,1.112,0V20.774a6.807,6.807,0,0,0,6.218-6.218h6.67a.556.556,0,0,0,0-1.112ZM14,19.687A5.687,5.687,0,1,1,19.687,14,5.694,5.694,0,0,1,14,19.687Z"
                                                        transform="translate(0)" />
                                                </g>
                                            </g>
                                        </svg>
                                    </a>
                                    <button id="search-button" type="button" class="btn btn-success search">Zoeken</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="search-messages center hidden">
                        <div class="search-message">
                            We can't seem to find "qsmkldjfmklqsdjfmklj" Please try to use a zip code, check your spelling, ...
                        </div>
                    </div>
                </div>
            </div>

            <div id="google-map" class="google-maps hidden"></div>

        </section>

        <hr class="invisible">
        <div class="container">
            <div class="row relative" style="height: 200px;">
                <div class="col-xs-12">
                    <div class="qp-marker">
                        <div class="qp-marker-container">
                            <div class="qp-marker-header">
                                <img src="/static/assets/svg/logo-diapositive.svg" class="qp-marker-logo" alt="Q-Park">
                                <a href="javascript:void(0);" class="qp-marker-close pull-right"><i class="fa fa-times"></i></a>
                            </div>

                            <div class="qp-marker-body">
                                <span class="qp-marker-title">Plein 1992</span>
                                <span class="qp-marker-text">2,3m doorijhoogte / 400 plaatsen</span>
                            </div>
                            <div class="qp-marker-footer">
                                <div class="qp-marker-travel-info">
                                    <img src="/static/assets/svg/person-walking-white.svg" alt="distance" width="15px">
                                    <span class="qp-marker-distance">1,6km</span> <span class="qp-marker-duration">23 h 45 min</span>
                                </div>
                                <a href="#" class="qp-marker-details btn btn-success pull-right">Details</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row relative" style="height: 200px;">
                <div class="col-xs-12">                    
                    <div class="qp-marker open">
                        <div class="qp-marker-container">
                            <div class="qp-marker-header">
                                <img src="/static/assets/svg/logo-diapositive.svg" class="qp-marker-logo" alt="Q-Park">
                                <a href="javascript:void(0);" class="qp-marker-close pull-right"><i class="fa fa-times"></i></a>
                            </div>

                            <div class="qp-marker-body">
                                <span class="qp-marker-title">Plein 1992</span>
                                <span class="qp-marker-text">2,3m doorijhoogte / 400 plaatsen</span>
                            </div>
                            <div class="qp-marker-footer">
                                <div class="qp-marker-travel-info">
                                    <img src="/static/assets/svg/person-walking-white.svg" alt="distance" width="15px">
                                    <span class="qp-marker-distance">1,6km</span> <span class="qp-marker-duration">23 h 45 min</span>
                                </div>
                                <a href="#" class="qp-marker-details btn btn-success pull-right">Details</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <hr class="invisible-small">

        <div class="container relative">
        </div>


        <!-- <hr class="invisible-small">

        <section class="" style="position: relative; background-color: rgba(0, 0, 0, 1); background-image: url('http://m.q-park.ie/DesktopModules/QPark.AdvancedPFL/image.aspx?PoiContentID=46&type=logo') ; background-repeat: no-repeat; background-size: cover; height: 500px;">
            <input id="google-maps-url" type="hidden" value="https://maps.googleapis.com/maps/api/js?key=AIzaSyCo1sZST0VSef3MJISi7F2qlVReuvLyzhU&libraries=places"
            />

            <div class="container">
                <div class="row" style="position: relative">
                    <input type="text" id="google-maps-search-query" class="google-autocomplete col-xs-12" style="z-index: 1;" value="Bonnefantenmuseum, Avenue Ceramique, Maastricht, Netherlands">
                    <div style="position: absolute; right: 5; z-index: 2;">
                        <a id="current-location" href="javascrip:void(0);">Location</a>
                        <a id="search-button" href="javascript:void(0);" class="btn btn-success">Search</a>
                    </div>
                </div>
            </div>

            <div id="google-map" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0;"></div>
        </section> -->

    </div>
    <script type="text/javascript">
        var mapsScriptLoaded = false;
        var mapsScriptInitiated = false;

        var autocompleteSelector = ".google-autocomplete";

        /* Custom Q-park marker*/

        function QparkMarkerOptions(options){
            this.clickable = options && options.clickable !== null && typeof options.clickable !== "undefined" ? options.clickable : false;
            this.title = options && options.title !== null && typeof options.title !== "undefined" ? options.title : "";
            this.text = options && options.text !== null && typeof options.text !== "undefined" ? options.text : "";
            this.distance = options && options.distance !== null && typeof options.distance !== "undefined" ? options.distance : "";
            this.duration = options && options.duration !== null && typeof options.duration !== "undefined" ? options.duration : "";
            this.buttonText = options && options.buttonText !== null && typeof options.buttonText !== "undefined" ? options.buttonText : "";
            this.buttonUrl = options && options.buttonUrl !== null && typeof options.buttonUrl !== "undefined" ? options.buttonUrl : "";
        }

        function QparkMarker(location, map, options) {
            var position = new google.maps.LatLng(location.lat, location.lng);
            var bounds = new google.maps.LatLngBounds(position, position);

            this.position_ = position;
            this.bounds_ = bounds;
            this.options_ = options;
            this.isComplexMarker_ = options && options.clickable && (options.title || options.text || options.distance || options.duration || options.buttonText);

            this.div_ = null;
            this.width_ = 0;
            this.height_ = 0;

            this.setMap(map);
        }

        function createCustomMarker() {
            QparkMarker.prototype = new google.maps.OverlayView();

            QparkMarker.prototype.createMarkerDiv = function() {
                var qpMarker = document.createElement("div");
                qpMarker.className = "qp-marker";

                return qpMarker;
            }

            QparkMarker.prototype.createMarkerContainerDiv = function() {
                var qpMarkerContainer = document.createElement("div");
                qpMarkerContainer.className = "qp-marker-container";

                return qpMarkerContainer;
            }

            QparkMarker.prototype.createHeaderDiv = function() {
                var qpMarkerHeader = document.createElement("div");
                qpMarkerHeader.className = "qp-marker-header";

                return qpMarkerHeader;
            }

            QparkMarker.prototype.createLogoImg = function() {
                var qpMarkerLogo = document.createElement("img");
                qpMarkerLogo.className = "qp-marker-logo";
                qpMarkerLogo.src = "/static/assets/svg/logo-diapositive.svg";
                qpMarkerLogo.alt = "Q-Park";

                return qpMarkerLogo;
            }
        
            QparkMarker.prototype.createSimpleMarker = function() {
                var qpMarker = this.createMarkerDiv();
                var qpMarkerContainer = this.createMarkerContainerDiv();
                
                // Header
                var qpMarkerHeader = this.createHeaderDiv();                        
                var qpMarkerLogo = this.createLogoImg();

                qpMarkerHeader.appendChild(qpMarkerLogo);
                qpMarkerContainer.appendChild(qpMarkerHeader);
                qpMarker.appendChild(qpMarkerContainer);

                return qpMarker;
            }

            QparkMarker.prototype.createComplexMarker = function() {
                var that = this;

                var qpMarker = this.createMarkerDiv();
                var qpMarkerContainer = this.createMarkerContainerDiv();

                // Header
                var qpMarkerHeader = this.createHeaderDiv();
                var qpMarkerLogo = this.createLogoImg();

                var qpMarkerClose = document.createElement("a");
                qpMarkerClose.className = "qp-marker-close pull-right";
                qpMarkerClose.href = "javascript:void(0);";
                qpMarkerClose.innerHTML = "<i class='fa fa-times'></i>";

                google.maps.event.addDomListener(qpMarkerClose, "click", function (e) {
                    e.stopPropagation();

                    qpMarker.className = qpMarker.className.replace( /(?:^|\s)open(?!\S)/g , "");
                    
                    that.updateMarkerDimensions();
                    that.draw();
                });

                qpMarkerHeader.appendChild(qpMarkerLogo);
                qpMarkerHeader.appendChild(qpMarkerClose);
                qpMarkerContainer.appendChild(qpMarkerHeader);

                // Body
                if (that.options_.title || that.options_.text) {
                    var qpMarkerBody = document.createElement("div");
                    qpMarkerBody.className = "qp-marker-body";

                    if (that.options_.title) {
                        var qpMarkerTitle = document.createElement("span");
                        qpMarkerTitle.className = "qp-marker-title";
                        qpMarkerTitle.innerHTML = that.options_.title;

                        qpMarkerBody.appendChild(qpMarkerTitle);
                    }

                    if (that.options_.text) {
                        var qpMarkerText = document.createElement("span");
                        qpMarkerText.className = "qp-marker-text";
                        qpMarkerText.innerHTML = that.options_.text;
                        
                        qpMarkerBody.appendChild(qpMarkerText);
                    }
                    
                    qpMarkerContainer.appendChild(qpMarkerBody);
                }

                // Footer
                if (that.options_.distance || that.options_.duration || that.options_.buttonText) {
                    var qpMarkerFooter = document.createElement("div");
                    qpMarkerFooter.className = "qp-marker-footer";

                    var qpMarkerTravelInfo = document.createElement("div");
                    qpMarkerTravelInfo.className = "qp-marker-travel-info";

                    if (that.options_.distance) {
                        var qpMarkerWalkingImg = document.createElement("img");
                        qpMarkerWalkingImg.src = "/static/assets/svg/person-walking-white.svg";
                        qpMarkerWalkingImg.alt = "distance";
                        qpMarkerWalkingImg.style.width = "15px";

                        var qpMarkerDistance = document.createElement("span");
                        qpMarkerDistance.className = "qp-marker-distance";
                        qpMarkerDistance.innerHTML = that.options_.distance;
                        
                        qpMarkerTravelInfo.appendChild(qpMarkerWalkingImg);
                        qpMarkerTravelInfo.appendChild(qpMarkerDistance);
                    }

                    var qpMarkerDuration = document.createElement("span");
                    qpMarkerDuration.className = "qp-marker-duration";
                    qpMarkerDuration.innerHTML = that.options_.duration;
                    
                    qpMarkerTravelInfo.appendChild(qpMarkerDuration);

                    var qpMarkerDetails = document.createElement("a");
                    qpMarkerDetails.className = "qp-marker-details btn btn-success pull-right";
                    qpMarkerDetails.href = that.options_.buttonUrl;
                    qpMarkerDetails.innerHTML = that.options_.buttonText;

                    qpMarkerFooter.appendChild(qpMarkerTravelInfo);
                    qpMarkerFooter.appendChild(qpMarkerDetails);
                    
                    qpMarkerContainer.appendChild(qpMarkerFooter);
                }

                qpMarker.appendChild(qpMarkerContainer);
                
                return qpMarker;
            }

            QparkMarker.prototype.updateMarkerDimensions = function() {
                var size = this.div_.getBoundingClientRect();
                this.width_ = size.width;
                this.height_ = size.height;
            };

            QparkMarker.prototype.isOpen = function() {
                return this.div_.className.match(/(?:^|\s)open(?!\S)/);
            };

            // onAdd is called when the map's panes are ready and the overlay has been
            // added to the map.
            QparkMarker.prototype.onAdd = function () {
                var that = this;

                var qpMarker = that.isComplexMarker_ ? that.createComplexMarker() : that.createSimpleMarker();

                that.div_ = qpMarker;

                // Add the element to the "overlayLayer" pane.
                var panes = that.getPanes();
                panes.overlayLayer.appendChild(qpMarker);

                if (that.isComplexMarker_) {
                    that.div_.className += " clickable";

                    // Add the element to the "overlayMouseTarget" pane to handle click events etc.
                    panes.overlayMouseTarget.appendChild(qpMarker);

                    google.maps.event.addDomListener(qpMarker, "click", function (e) {
                        e.stopPropagation();

                        if (!that.isOpen()) {
                            that.div_.className += " open";

                            that.updateMarkerDimensions();
                            that.draw();
                        }
                    });
                }

                that.updateMarkerDimensions();
            };

            // The onRemove() method will be called automatically from the API if
            // we ever set the overlay's map property to 'null'.
            QparkMarker.prototype.onRemove = function () {
                this.div_.parentNode.removeChild(this.div_);
                this.div_ = null;
            };

            QparkMarker.prototype.getPosition = function () {
                return this.position_;
            };

            QparkMarker.prototype.draw = function () {
                var overlayProjection = this.getProjection();

                var sw = overlayProjection.fromLatLngToDivPixel(this.bounds_.getSouthWest());
                var ne = overlayProjection.fromLatLngToDivPixel(this.bounds_.getNorthEast());

                // Resize the image's div to fit the indicated dimensions.
                var div = this.div_;
                div.style.left = (sw.x - (this.width_ / 2)) + "px";
                div.style.top = (ne.y - this.height_ - 10) + "px";
                /* div.style.width = (ne.x - sw.x) + 'px';
                div.style.height = (sw.y - ne.y) + 'px'; */
            };
        }

        /* End custom q-park marker */

        function getCityFromPlace(place) {
            /* var cityAddressComponent = place.address_components.filter(function (element, index) {
                return element.types.includes("locality");
            })[0];

            return cityAddressComponent ? cityAddressComponent.long_name : undefined; */
        }

        function getParkingFacilitesForCity(city) {
            var parkingFacilities = [];

            // BEGIN: get PF from Sitecore
            parkingFacilities.push({
                lat: 50.848830,
                long: 5.688137,
                title: "Vrijthof"
            });
            parkingFacilities.push({
                lat: 50.845824,
                long: 5.700661,
                title: "Plein 1992"
            });
            parkingFacilities.push({
                lat: 50.847712,
                long: 5.706356,
                title: "de Colonel"
            });
            parkingFacilities.push({
                lat: 50.852497,
                long: 5.703558,
                title: "P+R Station Maastricht"
            });
            parkingFacilities.push({
                lat: 50.846563,
                long: 5.694932,
                title: "O.L. Vrouweparking"
            });
            parkingFacilities.push({
                lat: 50.851379,
                long: 5.706219,
                title: "P+R Meerssenerweg"
            });
            // END: get PF from Sitecore

            return parkingFacilities;
        }

        function initMap(place) {
            if (!place || !place.geometry || !place.geometry.location) {
                return;
            }

            // Selected Place
            var location = {
                lat: place.geometry.location.lat(),
                lng: place.geometry.location.lng()
            };

            // Map Options
            var mapOptions = {
                center: location,
                zoom: 16,
                /* styles: [
                    {
                        featureType: "poi.business",
                        elementType: "labels",
                        stylers: [
                            { visibility: "off" }
                        ]
                    }
                ] */
            };

            // Create Map
            var map = new google.maps.Map(document.getElementById("google-map"), mapOptions);

            // Selected Place Marker
            var marker = new google.maps.Marker({
                position: location,
                map: map
            });

            var city = getCityFromPlace(place);

            // Parking Facilities
            var parkingFacilities = getParkingFacilitesForCity(city);
            var pfMarkers = [];

            var directionsService = new google.maps.DirectionsService();
            //var distanceMatrixService = new google.maps.DistanceMatrixService();

            // Parking Facility Directions
            $.each(parkingFacilities, function (index, parkingFacility) {
                var pfLocation = {
                    lat: parkingFacility.lat,
                    lng: parkingFacility.long
                };

                // Parking Facility Marker
                /* var pfMarker = new google.maps.Marker({
                    position: pfLocation,
                    map: map,
                    icon: "/static/assets/gmap/marker.png"
                }); */

                var pf = {
                    title: "Plein 1992",
                    text: "2,3m doorijhoogte / 400 plaatsen",
                    distance: "600m",
                    duration: "7 min.",
                    buttonText: "Details",
                    buttonUrl: "#"
                };

                var pfMarkerOptions = new QparkMarkerOptions({
                    clickable: true,
                    title: parkingFacility.title,
                    text: "2,3m doorijhoogte / 400 plaatsen",
                    distance: "600m",
                    duration: "7 min.",
                    buttonText: "Details",
                    buttonUrl: "#"
                });
                var pfMarker = new QparkMarker(pfLocation, map, pfMarkerOptions);

                pfMarker.addListener("click", function () {
                    console.log(pfMarker);
                });

                /* var infoWindow = new google.maps.InfoWindow({
                    content: "<div>Hello World!</div>",
                    pixelOffset: new google.maps.Size(0, 0)
                }); */

                /* pfMarker.addListener("click", function () {
                    //pfMarker.setVisible(false);
                    infoWindow.open(map, pfMarker);
                });

                infoWindow.addListener("closeclick", function () {
                    //pfMarker.setVisible(true);
                }); */

                pfMarkers.push(pfMarker);

                // Parking Facility Directions
                var request = {
                    origin: location,
                    destination: pfLocation,
                    travelMode: google.maps.DirectionsTravelMode.WALKING
                }

                directionsService.route(request, function (routeResponse, directionsServiceStatus) {
                    if (directionsServiceStatus === "OK") {
                        /* var getDistanceMatrixOptions = {
                            origins: [location],
                            destinations: [pfLocation],
                            travelMode: google.maps.DirectionsTravelMode.WALKING
                        }; */

                        /* distanceMatrixService.getDistanceMatrix(getDistanceMatrixOptions, function(distanceMatrixResponse, getDistanceMatrixStatus) {
                            var distanceMatrix = undefined; */

                        /* if (getDistanceMatrixStatus === "OK") {
                        } */

                        /* var infoWindow = new google.maps.InfoWindow();
                        infoWindow.setContent("Hello World!"); */

                        var directionsRendererOptions = {
                            map: map,
                            preserveViewport: true,
                            suppressMarkers: true,
                            //infoWindow: infoWindow
                        };

                        var directionsRenderer = new google.maps.DirectionsRenderer(directionsRendererOptions);
                        directionsRenderer.setDirections(routeResponse);
                        //});
                    }
                })
            });

            // Cluster
            var clusterOptions = {
                styles: [
                    {
                        textColor: "white",
                        textSize: 12,
                        url: "/static/assets/gmap/gmap-cluster.svg",
                        width: 35,
                        height: 35
                    }
                ]
            };

            var cluster = new MarkerClusterer(map, pfMarkers, clusterOptions);

            $("#google-map").removeClass("hidden");
        }

        function initAutoComplete() {
            $(autocompleteSelector).each(function (index) {
                var autocomplete = new google.maps.places.Autocomplete($(autocompleteSelector)[index]);

                google.maps.event.addListener(autocomplete, "place_changed", function () {
                    initMap(autocomplete.getPlace());
                });
            });
        }

        function performCallback(callback) {
            initAutoComplete();

            if (callback) {
                callback();
            }
        }

        function loadGoogleMapsApi(callback) {
            if (!mapsScriptLoaded && !mapsScriptInitiated) {
                mapsScriptInitiated = true;

                $.getScript($("#google-maps-url").val(), function () {
                    mapsScriptInitiated = false;
                    mapsScriptLoaded = true;

                    createCustomMarker();

                    performCallback(callback);
                });
            } else if (!mapsScriptInitiated) {
                performCallback(callback);
            }
        }

        function doSearch() { }

        function getCurrentPositionSuccess(position) {
            var geocoder = new google.maps.Geocoder();
            var geocoderOptions = {
                location: {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                }
            };

            geocoder.geocode(geocoderOptions, function (results, status) {
                if (status === google.maps.GeocoderStatus.OK && results[0]) {
                    $("#google-maps-search-query").val(results[0].formatted_address);
                    $("#search-button").trigger("click");
                }
            });
        }

        function getCurrentPositionError() {
            alert("Cannot access current location!");
        }

        function getCurrentPosition() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(getCurrentPositionSuccess, getCurrentPositionError)
            } else {
                getCurrentPositionError();
            }
        };

        $(function () {
            $("#search-button").on("click", function (e) {
                loadGoogleMapsApi(getCurrentPosition);
            });

            $("#current-location").on("click", function (e) {
                loadGoogleMapsApi(getCurrentPosition);
            });

            $(autocompleteSelector).on("keyup", function (e) {
                if ($(e.currentTarget).val().length >= 3) {
                    loadGoogleMapsApi();
                }
            });

            $(autocompleteSelector).on("textchange", function (e) {
                $("#search-button").prop("disabled", $(e.currentTarget).val() <= 0);
            });

            $(autocompleteSelector).on("keypress", function (e) {
                var keycode = (e.keyCode ? e.keyCode : e.which);

                if (keycode === "13") {
                    $("#search-button").trigger("click");
                    return false;
                }

                return true;
            });
        });
    </script>
</body>

</html>